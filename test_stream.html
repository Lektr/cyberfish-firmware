<!DOCTYPE html>
<html>
<head>
    <title>RPi Camera Stream</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #f0f0f0;
            font-family: Arial, sans-serif;
        }
        video {
            width: 1280px;
            height: 720px;
            max-width: 100%;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: #000;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            background: #fff;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <video id="video" autoplay playsinline></video>
    <div id="status" class="status">Status: Initializing...</div>

    <script>
        const video = document.getElementById('video');
        const statusDiv = document.getElementById('status');

        async function start() {
            // Configuration for local network only
const pc = new RTCPeerConnection({
    iceServers: [],
    iceTransportPolicy: 'all',
    bundlePolicy: 'max-bundle',
    // Add these to force local network usage
    rtcpMuxPolicy: 'require',
    iceCandidatePoolSize: 0
});

            pc.ontrack = (event) => {
                video.srcObject = event.streams[0];
                statusDiv.textContent = 'Status: Received remote stream';
            };


pc.onicecandidateerror = (event) => {
    console.error("ICE Candidate Error:", event);
    statusDiv.textContent = `Status: ICE Candidate Error - ${event.errorText}`;
};

pc.oniceconnectionstatechange = () => {
    statusDiv.textContent = `Status: ICE Connection State - ${pc.iceConnectionState}`;
    console.log("ICE Connection State:", pc.iceConnectionState);
    
    if (pc.iceConnectionState === 'failed') {
        // Try restarting ICE
        pc.restartIce();
    }
};

            pc.onicecandidate = (event) => {
                console.log("ICE candidate:", event.candidate);
                if (event.candidate) {
                    console.log("Local candidate:", {
                        address: event.candidate.address,
                        port: event.candidate.port,
                        type: event.candidate.type,
                        protocol: event.candidate.protocol
                    });
                }
            };

            pc.onicegatheringstatechange = () => {
                console.log("ICE gathering state:", pc.iceGatheringState);
                statusDiv.textContent = `Status: ICE Gathering State - ${pc.iceGatheringState}`;
            };

            try {
                const offer = await pc.createOffer({
                    offerToReceiveVideo: true,
                    offerToReceiveAudio: false
                });
                await pc.setLocalDescription(offer);
                statusDiv.textContent = 'Status: Created offer, waiting for answer...';

                const response = await fetch('http://10.10.10.10:6900/offer', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        sdp: pc.localDescription.sdp,
                        type: pc.localDescription.type
                    })
                });

                const answer = await response.json();
                await pc.setRemoteDescription(answer);
                statusDiv.textContent = 'Status: Received answer, establishing connection...';
            } catch (e) {
                console.error(e);
                statusDiv.textContent = `Status: Error - ${e.message}`;
            }
        }

        start();
    </script>
</body>
</html>
